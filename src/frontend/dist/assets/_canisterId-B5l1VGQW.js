var Ee=Object.defineProperty;var Ce=(e,a,s)=>a in e?Ee(e,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[a]=s;var G=(e,a,s)=>Ce(e,typeof a!="symbol"?a+"":a,s);import{e as L,r as y,j as t,H as qe,A as D,u as Pe,f as T,g as Ge,h as Ue}from"./index-CstboGu2.js";import{u as ee}from"./useNFTCollection-BIcAHKQV.js";import{u as Q,a as Y,b as H,c as Qe,d as ze,e as te,f as ne}from"./useNFTMetadata-BLxtY6Ku.js";import{i as $e}from"./index-3JlJGJwM.js";function Ke(e){const a=L(),s=Q(),r=Y(e,$e);return H({mutationFn:async l=>{if(!s)throw new Error("User must be authenticated to approve tokens");return r.icrc37_approve_tokens([l])},onSuccess:()=>a.invalidateQueries()})}function ae(e,a,s){const[r,d]=y.useState(null),[l,c]=y.useState(!0),[n,u]=y.useState(null),{request:i}=Qe(e);return y.useEffect(()=>{if(console.log("useNFTOwner called with canisterId:",e,"tokenId:",a),!e||a==null)return;i(a).then(m=>{console.log("Fetched NFT owner:",m),d(m),u(null)}).catch(m=>u(m)).finally(()=>c(!1))},[e,a,s==null?void 0:s.override,s==null?void 0:s.queryArgs,i]),{owner:r,loading:l,error:n}}const Ye=({canisterId:e,collection:a,loadingComponent:s,errorComponent:r})=>{const{collection:d,loading:l,error:c}=ee(e),n=a!==void 0?a:d;return l?s||t.jsx("div",{className:"py-8 text-center text-gray-500 animate-pulse",children:"Loading collection..."}):c?r||t.jsx("div",{className:"py-8 text-center text-red-500",children:"Failed to load collection metadata."}):n?t.jsxs("div",{className:"max-w-2xl mx-auto px-4 py-8 bg-white rounded-2xl shadow-md border space-y-8",children:[t.jsxs("div",{className:"flex items-center space-x-5",children:[n.logo?t.jsx("img",{src:n.logo,alt:n.name||"",className:"w-16 h-16 rounded-full border bg-gray-100 object-contain"}):t.jsx("div",{className:"w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center text-gray-400 text-3xl font-bold border",children:n.name?n.name[0]:"?"}),t.jsxs("div",{className:"space-y-1",children:[t.jsx("div",{className:"text-2xl font-semibold text-gray-900",children:n.name||e.substring(0,6)+"..."}),t.jsx("div",{className:"flex items-center space-x-3",children:n.symbol&&t.jsx("div",{className:"text-lg text-gray-500",children:n.symbol})})]})]}),n.description&&t.jsx("div",{className:"text-gray-700 text-base whitespace-pre-line",children:n.description}),t.jsxs("div",{className:"flex flex-wrap gap-4 text-sm text-gray-500",children:[n.totalSupply!==void 0&&t.jsxs("div",{children:[t.jsx("span",{className:"font-medium text-gray-700",children:"Total Supply:"})," ",n.totalSupply.toString()]}),n.supplyCap!==void 0&&t.jsxs("div",{children:[t.jsx("span",{className:"font-medium text-gray-700",children:"Supply Cap:"})," ",n.supplyCap.toString()]}),n.maxQueryBatchSize!==void 0&&t.jsxs("div",{children:[t.jsx("span",{className:"font-medium text-gray-700",children:"Max Query Batch:"})," ",n.maxQueryBatchSize.toString()]}),n.atomicBatchTransfers!==void 0&&t.jsxs("div",{children:[t.jsx("span",{className:"font-medium text-gray-700",children:"Atomic Batching:"})," ",n.atomicBatchTransfers?"Yes":"No"]})]})]}):t.jsx("div",{className:"py-8 text-center text-gray-400",children:"Collection not found"})};function He(e,a){const s=[];for(let r=0;r<e.length;r+=a)s.push(e.slice(r,r+a));return s}const U=class U{constructor(){G(this,"queues",new Map);G(this,"timer",null)}static get instance(){return this._instance||(this._instance=new U),this._instance}request(a,s,r){console.log("[MarketListingBatcher] Request for canisterId:",a,"tokenId:",r);let d=this.queues.get(a);d||(d={fetcher:s,tokenMap:new Map},this.queues.set(a,d),console.log("[MarketListingBatcher] Created new queue for canisterId:",a));let l=d.tokenMap.get(r);if(!l){let c,n;l={promise:new Promise((i,g)=>{c=i,n=g}),resolve:c,reject:n},d.tokenMap.set(r,l),console.log("[MarketListingBatcher] Added tokenId to queue:",r)}return this.scheduleFlush(),l.promise}scheduleFlush(){this.timer||(console.log("[MarketListingBatcher] Scheduling flush in 10ms"),this.timer=setTimeout(()=>{this.flush(),this.timer=null},10))}async flush(){console.log("[MarketListingBatcher] Flushing all queues...");for(const[a,{fetcher:s,tokenMap:r}]of this.queues.entries()){const d=Array.from(r.keys()),l=He(d,25);console.log("[MarketListingBatcher] Flushing canisterId:",a,"tokenIds:",d);try{for(const c of l){console.log("[MarketListingBatcher] Fetching batch:",c);const n=await s(c);console.log("[MarketListingBatcher] Received results for batch:",n);const u=new Map;Array.isArray(n)&&n.forEach(i=>{if(i&&typeof i=="object"&&"original_config"in i){const g=i.original_config;if(Array.isArray(g)){for(const m of g)if(m&&m[0]&&"intent_tokens"in m[0]){const p=m[0].intent_tokens;if(Array.isArray(p)){for(const f of p)if(f&&f.kind&&"intent"in f.kind){const N=f.kind.intent;for(const o of N)if(o&&o[0]&&o[0].inventory){const h=o[0].inventory;if(h&&h[0]&&"tokenIds"in h[0]){const _=h[0].tokenIds;for(const x of _)u.set(BigInt(x),i),console.log(`[MarketListingBatcher] Mapped tokenId ${x} to result:`,i)}}}}}}}}),c.forEach(i=>{const g=r.get(i),m=u.has(i)?u.get(i):null;console.log("[MarketListingBatcher] Resolving tokenId:",i,"result:",m),g.resolve(m)})}}catch(c){console.error("[MarketListingBatcher] Error during flush:",c),r.forEach(n=>n.reject(c))}this.queues.delete(a),console.log("[MarketListingBatcher] Cleared queue for canisterId:",a)}}};G(U,"_instance");let K=U;const Je=K.instance,J=({IDL:e})=>{const a=e.Rec(),s=e.Rec(),r=e.Nat,d=e.Record({id:e.Nat,time:r}),l=e.Record({aSync:e.Opt(e.Nat),actionType:e.Text,params:e.Vec(e.Nat8),retries:e.Nat});e.Record({nextCycleActionId:e.Opt(e.Nat),maxExecutions:e.Opt(e.Nat),nextActionId:e.Nat,lastActionIdReported:e.Opt(e.Nat),lastCycleReport:e.Opt(e.Nat),initialTimers:e.Vec(e.Tuple(d,l)),expectedExecutionTime:r,lastExecutionTime:r}),e.Record({});const c=e.Record({owner:e.Principal,subaccount:e.Opt(e.Vec(e.Nat8))}),n=e.Variant({ICRC1:e.Null,ICRC2:e.Null,ICRC4:e.Null,ICRC7:e.Null,ICRC37:e.Null,ICRC80:e.Opt(e.Vec(e.Nat8))}),u=e.Variant({decimals:e.Nat,transfer_from_fee:e.Nat,transfer_fee:e.Nat,standards:e.Vec(n),external_fee:a,approval_fee:e.Nat}),i=e.Variant({tokenIds:e.Vec(e.Nat),quantity:e.Nat});a.fill(e.Record({token_pointer:e.Opt(e.Vec(e.Nat8)),meta:e.Opt(e.Vec(u)),inventory:e.Opt(i),canister:e.Principal}));const g=e.Record({target_intent_id:e.Opt(e.Nat),owner:c,kind:e.Variant({intent:e.Vec(e.Opt(a)),settlement:e.Vec(e.Opt(a))}),counterparty:e.Opt(c),lock_to_date:e.Opt(e.Nat)}),m=e.Variant({allow_partial:e.Null,memo:e.Vec(e.Nat8),created_at:e.Nat,start_date:e.Nat,allow_list:e.Vec(c),satisfying_tokens:e.Vec(e.Vec(a)),intent_tokens:e.Vec(g),namespace:e.Text,ending:e.Variant({date:e.Nat,perpetual:e.Null,immediate:e.Null,timeout:e.Nat})}),p=e.Variant({withdraw_escrow:g,execute_intent:e.Record({satisfying_intent:e.Vec(e.Opt(m)),intent_ids:e.Vec(e.Nat)}),distribute_intent:e.Nat,withdraw_settlement:g,end_intent:e.Nat,list_intent:e.Vec(e.Opt(m))}),f=e.Record({token_pointer:e.Opt(e.Vec(e.Nat8)),result:e.Variant({Ok:e.Vec(e.Nat),Err:e.Text}),meta:e.Opt(e.Vec(u)),inventory:e.Opt(i),receiving_account:c,sending_account:c,canister:e.Principal,namespace:e.Opt(e.Text),intent_id:e.Opt(e.Nat)}),N=e.Record({id:e.Nat,actions:e.Vec(f)}),o=e.Record({message:e.Text,error_code:e.Nat}),h=e.Variant({withdraw_escrow:e.Variant({Ok:N,Err:o}),execute_intent:e.Variant({Ok:N,Err:o}),distribute_intent:e.Variant({Ok:N,Err:o}),withdraw_settlement:e.Variant({Ok:N,Err:o}),end_intent:e.Variant({Ok:N,Err:o}),list_intent:e.Variant({Ok:N,Err:o})}),_=e.Variant({pending:e.Null,fulfilled:e.Opt(e.Nat),open:e.Null,withdrawn_settling:e.Opt(e.Nat),error:e.Opt(e.Text),settling:e.Null,withdrawn:e.Opt(e.Nat),encumbered:e.Opt(e.Principal)}),x=e.Variant({participant_accounts:e.Vec(c),owner_accounts:e.Vec(c),statuses:e.Vec(_),owner_principals:e.Vec(e.Principal),satisfying_tokens:e.Vec(a),participant_principals:e.Vec(e.Principal),intent_ids:e.Vec(e.Nat),listed_tokens:e.Vec(a)}),k=e.Variant({participants:e.Vec(e.Principal),actions:e.Vec(f),allow_list:e.Vec(e.Principal),escrow:e.Vec(g),namespace:e.Text}),w=e.Record({status:_,original_config:e.Vec(e.Opt(m)),owner:c,feature_status:e.Vec(e.Opt(k)),current_config:e.Opt(e.Vec(e.Opt(m))),intent_id:e.Nat,settled_at:e.Opt(e.Tuple(e.Principal,e.Nat))});s.fill(e.Variant({Map:e.Vec(e.Tuple(e.Text,s)),Nat:e.Nat,Blob:e.Vec(e.Nat8),Text:e.Text,Array:e.Vec(s)}));const O=e.Variant({Generic:e.Text,NoExecution:e.Null}),M=e.Variant({Ok:e.Variant({execution:e.Variant({full:e.Vec(f),partial:e.Vec(f)}),temporary:e.Variant({full:e.Vec(f),partial:e.Vec(f)})}),Error:O}),V=e.Vec(e.Nat8),v=e.Record({owner:e.Principal,subaccount:e.Opt(V)}),j=e.Nat,b=e.Nat,E=e.Nat64,F=e.Variant({GenericError:e.Record({message:e.Text,error_code:e.Nat}),TemporarilyUnavailable:e.Null,BadBurn:e.Record({min_burn_amount:b}),Duplicate:e.Record({duplicate_of:j}),BadFee:e.Record({expected_fee:b}),CreatedInFuture:e.Record({ledger_time:E}),TooOld:e.Null,InsufficientFunds:e.Record({balance:b})}),R=e.Variant({Ok:j,Err:F});return e.Service({hello:e.Func([],[e.Text],[]),icrc8_balance_of:e.Func([e.Opt(c),e.Opt(g),e.Opt(e.Nat)],[e.Vec(g)],["query"]),icrc8_escrow_account:e.Func([e.Vec(g)],[e.Vec(e.Record({tokens:e.Opt(e.Vec(a)),account:c}))],["query"]),icrc8_manage_market:e.Func([e.Vec(e.Opt(p))],[e.Vec(e.Opt(h))],[]),icrc8_market_info:e.Func([e.Opt(e.Vec(x)),e.Opt(e.Nat),e.Opt(e.Nat)],[e.Vec(w)],["query"]),icrc8_metadata:e.Func([],[e.Vec(e.Record({value:s,text:e.Text}))],["query"]),icrc8_supported_tokens:e.Func([],[e.Opt(e.Vec(a))],["query"]),icrc8_validate_intents:e.Func([e.Vec(e.Nat),e.Vec(e.Vec(m))],[M],["query"]),mint_fake_tokens:e.Func([e.Principal,v,e.Nat],[R],[])})};var We={};const Z=We.CANISTER_ID_MARKET,Ze=(e,a={})=>{const s=a.agent||new qe({...a.agentOptions});return a.agent&&a.agentOptions&&console.warn("Detected both agent and agentOptions passed to createActor. Ignoring agentOptions and proceeding with the provided agent."),D.createActor(J,{agent:s,canisterId:e,...a.actorOptions})};Z&&Ze(Z);function re(e,a,s,r){const[d,l]=y.useState(null),[c,n]=y.useState(!0),[u,i]=y.useState(null),g=Pe(),m=y.useCallback(p=>{const f=D.createActor(J,{agent:g,canisterId:e}),N=[{listed_tokens:[{canister:T.fromText(a),token_pointer:[],meta:[],inventory:[{tokenIds:p}]}]},{statuses:[{open:null}]}];return console.log("filter is ",N),console.log("Querying market with tokenIds:",p),f.icrc8_market_info([N],[],[]).then(o=>(console.log("Market query results:",o),o))},[g,e,a]);return y.useEffect(()=>{!e||s==null||(n(!0),Je.request(e,m,s).then(p=>{console.log("Fetched market listing:",p),l(p),i(null)}).catch(p=>i(p)).finally(()=>n(!1)))},[e,s,r==null?void 0:r.override,r==null?void 0:r.queryArgs,m]),{listing:d,loading:c,error:u}}const Xe=({IDL:e})=>{const a=e.Rec(),s=e.Rec(),r=e.Rec(),d=e.Variant({Environment:e.Null,Fixed:e.Nat}),l=e.Vec(e.Nat8),c=e.Record({owner:e.Principal,subaccount:e.Opt(l)}),n=e.Nat,u=e.Vec(e.Nat8),i=e.Nat64,g=e.Record({from:c,memo:e.Opt(u),created_at_time:e.Opt(i),amount:n}),m=e.Record({to:c,memo:e.Opt(u),created_at_time:e.Opt(i),amount:n}),p=e.Nat,f=e.Record({to:c,fee:e.Opt(n),from:c,memo:e.Opt(u),created_at_time:e.Opt(i),amount:n}),N=e.Record({burn:e.Opt(g),kind:e.Text,mint:e.Opt(m),timestamp:i,index:p,transfer:e.Opt(f)}),o=e.Record({existing_balances:e.Vec(e.Tuple(c,n)),burned_tokens:n,fee_collector_emitted:e.Bool,minted_tokens:n,local_transactions:e.Vec(N),fee_collector_block:e.Nat});s.fill(e.Variant({Int:e.Int,Map:e.Vec(e.Tuple(e.Text,s)),Nat:e.Nat,Blob:e.Vec(e.Nat8),Text:e.Text,Array:e.Vec(s)})),e.Record({fee:e.Opt(d),advanced_settings:e.Opt(o),max_memo:e.Opt(e.Nat),decimals:e.Nat8,metadata:e.Opt(s),minting_account:e.Opt(c),logo:e.Opt(e.Text),permitted_drift:e.Opt(i),name:e.Opt(e.Text),settle_to_accounts:e.Opt(e.Nat),fee_collector:e.Opt(c),transaction_window:e.Opt(i),min_burn_amount:e.Opt(n),max_supply:e.Opt(n),max_accounts:e.Opt(e.Nat),symbol:e.Opt(e.Text)});const h=e.Variant({ICRC1:e.Null,Environment:e.Null,Fixed:e.Nat}),_=e.Vec(e.Nat8),x=e.Record({owner:e.Principal,subaccount:e.Opt(_)}),k=e.Record({from_subaccount:e.Opt(e.Vec(e.Nat8)),amount:e.Nat,expires_at:e.Opt(e.Nat64),spender:x}),w=e.Record({existing_approvals:e.Vec(e.Tuple(e.Tuple(x,x),k))}),O=e.Variant({TotalSupply:e.Null,Fixed:e.Nat});e.Record({fee:e.Opt(h),advanced_settings:e.Opt(w),max_allowance:e.Opt(O),max_approvals:e.Opt(e.Nat),max_approvals_per_account:e.Opt(e.Nat),settle_to_approvals:e.Opt(e.Nat)});const M=e.Variant({Stable:e.Null,StableTyped:e.Null,Managed:e.Null}),V=e.Record({url:e.Text,block_type:e.Text}),v=e.Record({maxRecordsToArchive:e.Nat,archiveIndexType:M,maxArchivePages:e.Nat,settleToRecords:e.Nat,archiveCycles:e.Nat,maxActiveRecords:e.Nat,maxRecordsInArchiveInstance:e.Nat,archiveControllers:e.Opt(e.Opt(e.Vec(e.Principal))),supportedBlocks:e.Vec(V)});e.Opt(v);const j=e.Variant({ICRC1:e.Null,Environment:e.Null,Fixed:e.Nat});e.Record({fee:e.Opt(j),max_balances:e.Opt(e.Nat),max_transfers:e.Opt(e.Nat)});const b=e.Variant({Fee:d,Metadata:e.Tuple(e.Text,e.Opt(s)),Symbol:e.Text,Logo:e.Text,Name:e.Text,MaxSupply:e.Opt(e.Nat),MaxMemo:e.Nat,MinBurnAmount:e.Opt(e.Nat),TransactionWindow:e.Nat64,PermittedDrift:e.Nat64,SettleToAccounts:e.Nat,MintingAccount:c,FeeCollector:e.Opt(c),MaxAccounts:e.Nat,Decimals:e.Nat8}),E=e.Variant({Fee:h,MaxAllowance:e.Opt(O),MaxApprovalsPerAccount:e.Nat,MaxApprovals:e.Nat,SettleToApprovals:e.Nat}),F=e.Variant({Fee:j,MaxBalances:e.Nat,MaxTransfers:e.Nat}),R=e.Record({memo:e.Opt(u),from_subaccount:e.Opt(l),created_at_time:e.Opt(i),amount:n}),q=e.Variant({GenericError:e.Record({message:e.Text,error_code:e.Nat}),TemporarilyUnavailable:e.Null,BadBurn:e.Record({min_burn_amount:n}),Duplicate:e.Record({duplicate_of:p}),BadFee:e.Record({expected_fee:n}),CreatedInFuture:e.Record({ledger_time:i}),TooOld:e.Null,InsufficientFunds:e.Record({balance:n})}),S=e.Variant({Ok:p,Err:q}),W=e.Record({last_block_index:e.Vec(e.Nat8),hash_tree:e.Vec(e.Nat8),last_block_hash:e.Vec(e.Nat8)}),P=e.Record({url:e.Text,name:e.Text}),A=e.Record({owner:e.Principal,subaccount:e.Opt(l)}),C=e.Nat,B=e.Tuple(e.Text,s),oe=e.Record({to:c,fee:e.Opt(n),memo:e.Opt(u),from_subaccount:e.Opt(l),created_at_time:e.Opt(i),amount:n}),ie=e.Record({account:x,spender:x}),le=e.Record({allowance:e.Nat,expires_at:e.Opt(e.Nat64)}),de=e.Record({fee:e.Opt(e.Nat),memo:e.Opt(e.Vec(e.Nat8)),from_subaccount:e.Opt(e.Vec(e.Nat8)),created_at_time:e.Opt(e.Nat64),amount:e.Nat,expected_allowance:e.Opt(e.Nat),expires_at:e.Opt(e.Nat64),spender:x}),ue=e.Variant({GenericError:e.Record({message:e.Text,error_code:e.Nat}),TemporarilyUnavailable:e.Null,Duplicate:e.Record({duplicate_of:e.Nat}),BadFee:e.Record({expected_fee:e.Nat}),AllowanceChanged:e.Record({current_allowance:e.Nat}),CreatedInFuture:e.Record({ledger_time:e.Nat64}),TooOld:e.Null,Expired:e.Record({ledger_time:e.Nat64}),InsufficientFunds:e.Record({balance:e.Nat})}),pe=e.Variant({Ok:e.Nat,Err:ue}),me=e.Record({to:x,fee:e.Opt(e.Nat),spender_subaccount:e.Opt(e.Vec(e.Nat8)),from:x,memo:e.Opt(e.Vec(e.Nat8)),created_at_time:e.Opt(e.Nat64),amount:e.Nat}),ge=e.Variant({GenericError:e.Record({message:e.Text,error_code:e.Nat}),TemporarilyUnavailable:e.Null,InsufficientAllowance:e.Record({allowance:e.Nat}),BadBurn:e.Record({min_burn_amount:e.Nat}),Duplicate:e.Record({duplicate_of:e.Nat}),BadFee:e.Record({expected_fee:e.Nat}),CreatedInFuture:e.Record({ledger_time:e.Nat64}),TooOld:e.Null,InsufficientFunds:e.Record({balance:e.Nat})}),xe=e.Variant({Ok:e.Nat,Err:ge}),fe=e.Record({from:e.Opt(e.Principal)}),Ne=e.Record({end:e.Nat,canister_id:e.Principal,start:e.Nat}),he=e.Vec(Ne),z=e.Record({start:e.Nat,length:e.Nat}),_e=e.Vec(z);r.fill(e.Variant({Int:e.Int,Map:e.Vec(e.Tuple(e.Text,r)),Nat:e.Nat,Blob:e.Vec(e.Nat8),Text:e.Text,Array:e.Vec(r)}));const ye=e.Record({log_length:e.Nat,blocks:e.Vec(e.Record({id:e.Nat,block:r})),archived_blocks:e.Vec(a)}),be=e.Func([e.Vec(z)],[ye],["query"]);a.fill(e.Record({args:e.Vec(z),callback:be}));const Te=e.Record({log_length:e.Nat,blocks:e.Vec(e.Record({id:e.Nat,block:r})),archived_blocks:e.Vec(a)}),ve=e.Record({certificate:e.Vec(e.Nat8),hash_tree:e.Vec(e.Nat8)}),we=e.Record({url:e.Text,block_type:e.Text}),ke=e.Vec(e.Nat8),Oe=e.Record({owner:e.Principal,subaccount:e.Opt(ke)}),je=e.Record({accounts:e.Vec(Oe)}),Ve=e.Vec(e.Nat),Fe=e.Record({to:c,fee:e.Opt(n),memo:e.Opt(u),from_subaccount:e.Opt(l),created_at_time:e.Opt(i),amount:n}),Re=e.Vec(Fe),Ae=e.Variant({TooManyRequests:e.Record({limit:e.Nat}),GenericError:e.Record({message:e.Text,error_code:e.Nat}),TemporarilyUnavailable:e.Null,BadBurn:e.Record({min_burn_amount:e.Nat}),Duplicate:e.Record({duplicate_of:e.Nat}),BadFee:e.Record({expected_fee:e.Nat}),CreatedInFuture:e.Record({ledger_time:e.Nat64}),GenericBatchError:e.Record({message:e.Text,error_code:e.Nat}),TooOld:e.Null,InsufficientFunds:e.Record({balance:e.Nat})}),Me=e.Variant({Ok:e.Nat,Err:Ae}),Se=e.Vec(e.Opt(Me)),Be=e.Record({to:c,memo:e.Opt(u),created_at_time:e.Opt(i),amount:n});return e.Service({admin_init:e.Func([],[],[]),admin_update_icrc1:e.Func([e.Vec(b)],[e.Vec(e.Bool)],[]),admin_update_icrc2:e.Func([e.Vec(E)],[e.Vec(e.Bool)],[]),admin_update_icrc4:e.Func([e.Vec(F)],[e.Vec(e.Bool)],[]),admin_update_owner:e.Func([e.Principal],[e.Bool],[]),burn:e.Func([R],[S],[]),deposit_cycles:e.Func([],[],[]),get_tip:e.Func([],[W],["query"]),icrc10_supported_standards:e.Func([],[e.Vec(P)],["query"]),icrc1_balance_of:e.Func([A],[C],["query"]),icrc1_decimals:e.Func([],[e.Nat8],["query"]),icrc1_fee:e.Func([],[C],["query"]),icrc1_metadata:e.Func([],[e.Vec(B)],["query"]),icrc1_minting_account:e.Func([],[e.Opt(A)],["query"]),icrc1_name:e.Func([],[e.Text],["query"]),icrc1_supported_standards:e.Func([],[e.Vec(P)],["query"]),icrc1_symbol:e.Func([],[e.Text],["query"]),icrc1_total_supply:e.Func([],[C],["query"]),icrc1_transfer:e.Func([oe],[S],[]),icrc2_allowance:e.Func([ie],[le],["query"]),icrc2_approve:e.Func([de],[pe],[]),icrc2_transfer_from:e.Func([me],[xe],[]),icrc3_get_archives:e.Func([fe],[he],["query"]),icrc3_get_blocks:e.Func([_e],[Te],["query"]),icrc3_get_tip_certificate:e.Func([],[e.Opt(ve)],["query"]),icrc3_supported_block_types:e.Func([],[e.Vec(we)],["query"]),icrc4_balance_of_batch:e.Func([je],[Ve],["query"]),icrc4_maximum_query_batch_size:e.Func([],[e.Opt(e.Nat)],["query"]),icrc4_maximum_update_batch_size:e.Func([],[e.Opt(e.Nat)],["query"]),icrc4_transfer_batch:e.Func([Re],[Se],[]),mint:e.Func([Be],[S],[])})};function Ie(e){const a=L(),s=Q(),r=Y(e,Xe);return H({mutationFn:async l=>{if(!s)throw new Error("User must be authenticated to approve tokens");return console.log("Approving token with args:",l),r.icrc2_approve(l)},onSuccess:()=>{a.invalidateQueries({queryKey:["fungible-token",e]})}})}function se(e){console.log("useManageMarket called with canisterId:",e);const a=Q(),s=Y(e,J),r=async d=>{if(!a)throw new Error("User must be authenticated to manage market");console.log("Managing market with args:",d);const l=d.map(c=>[c]);return console.log("Wrapped args for actor call:",l),console.log("First wrapped arg:",l[0]),s.icrc8_manage_market(l)};return console.log("useManageMarket mutation function created"),H({mutationFn:r})}const $=[{canisterId:"uzt4z-lp777-77774-qaabq-cai",symbol:"TTT",name:"Test Token",decimals:8}];function ce({listing:e,marketCanisterId:a,intentId:s,nftCanisterId:r,tokenId:d,owner:l}){var p;const{connect:c,user:n}=ze(),u=Q(),i=Ge(),g=u&&!!i,m=l&&n&&l.owner===(typeof n.principal=="string"?n.principal:n.principal.toString());if(e){console.log("MarketListingPrice called with listing:",e);let f=null,N=null;if(e&&Array.isArray(e.original_config)){for(const h of e.original_config)if(console.log("Checking original_config feature:",h),h&&h[0]&&"satisfying_tokens"in h[0]){console.log("Found satisfying_tokens in original_config:",h[0]);const _=h[0].satisfying_tokens;if(Array.isArray(_)&&_.length>0&&Array.isArray(_[0])&&_[0].length>0){const x=_[0][0];if(x){N=(p=x.canister)!=null&&p.toText?x.canister.toText():x.canister,x.inventory&&Array.isArray(x.inventory)&&x.inventory.length>0&&x.inventory[0]!==void 0&&typeof x.inventory[0]=="object"&&x.inventory[0]!==null&&"quantity"in x.inventory[0]&&x.inventory[0].quantity!=null&&(f=x.inventory[0].quantity);break}}}}if(!f||!N)return null;const o=typeof N=="string"?N:N&&typeof N=="object"&&"toText"in N&&typeof N.toText=="function"?N.toText():"";return o?g?t.jsx(Le,{price:f,tokenCanisterIdStr:o,marketCanisterId:a,intentId:s,user:n,listing:e,nftCanisterId:r,tokenId:d}):u&&!i?t.jsx(X,{price:f,tokenCanisterIdStr:o,isAuthenticated:!1,onLogin:void 0,isConnecting:!0}):t.jsx(X,{price:f,tokenCanisterIdStr:o,isAuthenticated:!1,onLogin:async()=>{try{await c()}catch(h){console.error("Login failed:",h),alert("Failed to connect wallet. Please try again.")}}}):null}return m?g?t.jsx(De,{nftCanisterId:r,tokenId:d,marketCanisterId:a,user:n}):t.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[t.jsx("span",{className:"text-gray-500 text-xs",children:"You own this NFT"}),u&&!i?t.jsx("span",{className:"ml-2 px-3 py-1 rounded bg-gray-400 text-white text-xs",children:"Connecting..."}):t.jsx("button",{className:"ml-2 px-3 py-1 rounded bg-green-600 text-white text-xs hover:bg-green-700",onClick:async()=>{try{await c()}catch(f){console.error("Login failed:",f),alert("Failed to connect wallet. Please try again.")}},children:"Connect to List"})]}):t.jsx("div",{className:"text-xs text-gray-400",children:"Not listed"})}function X({price:e,tokenCanisterIdStr:a,isAuthenticated:s,onLogin:r,isConnecting:d}){const l=te(a),{data:c,isLoading:n,error:u}=l;if(n)return t.jsx("span",{className:"text-gray-400",children:"Loading price..."});if(u)return t.jsx("span",{className:"text-red-500",children:"Error loading token info"});if(!c)return t.jsx("span",{className:"text-gray-400",children:"No token info"});const{symbol:i,decimals:g}=c,m=g!=null?Number(e)/10**g:e.toString();return t.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[t.jsxs("span",{className:"font-mono text-green-700",children:[i," ",m]}),!s&&(d?t.jsx("span",{className:"ml-2 px-3 py-1 rounded bg-gray-400 text-white text-xs",children:"Connecting..."}):r?t.jsx("button",{className:"ml-2 px-3 py-1 rounded bg-green-600 text-white text-xs hover:bg-green-700",onClick:r,children:"Connect to Buy"}):null)]})}function Le({price:e,tokenCanisterIdStr:a,marketCanisterId:s,intentId:r,user:d,listing:l,nftCanisterId:c,tokenId:n}){const u=Ie(a),i=se(s),g=async()=>{if(!d){alert("Please connect your wallet first");return}const w=d.principal.toString();if(console.log("handleBuy called with:",{buyerPrincipal:w,marketCanisterId:s,intentId:r,price:e}),!w||!s||!r){alert("Missing required information for purchase");return}try{const O=x||0n,M={from_subaccount:[],spender:{owner:T.fromText(s),subaccount:[]},amount:BigInt(e)+O,expected_allowance:[],fee:[],memo:[],created_at_time:[BigInt(Date.now()*1e6)],expires_at:[]};console.log("Approve args:",M);const V=await u.mutateAsync(M);if(console.log("Approve result:",V),V&&typeof V=="object"&&"Err"in V){alert("Approval failed");return}const v=[];console.log("Constructing satisfying intent for listing:",l);const j={owner:typeof d.principal=="string"?T.fromText(d.principal):d.principal,subaccount:[]},b=typeof r=="string"?BigInt(r):r,F=[[{canister:T.fromText(a),inventory:[{quantity:BigInt(e)}],meta:[],token_pointer:[]}]],q={intent_tokens:[{target_intent_id:[b],owner:j,kind:{intent:F},counterparty:[],lock_to_date:[]}]};v.push([q]);const S=typeof n=="string"?BigInt(n):n,P={satisfying_tokens:[[{canister:T.fromText(c),inventory:[{tokenIds:[S]}],meta:[],token_pointer:[]}]]};v.push([P]),console.log("Constructed satisfying intent features:",v),console.log("Number of satisfying_tokens features:",v.filter(B=>B[0]&&"satisfying_tokens"in B[0]).length),console.log("Number of intent_tokens features:",v.filter(B=>B[0]&&"intent_tokens"in B[0]).length),console.log("Type verification before sending:"),console.log("- intentIdBigInt:",typeof b,b),console.log("- buyerAccount.owner:",typeof j.owner,j.owner),console.log("- price (as BigInt):",typeof BigInt(e),BigInt(e)),console.log("- tokenCanister Principal:",typeof T.fromText(a),T.fromText(a)),console.log("- nftCanister Principal:",typeof T.fromText(c),T.fromText(c)),console.log("- tokenIdBigInt:",typeof S,S);const A={execute_intent:{intent_ids:[b],satisfying_intent:v}};console.log("Executing intent with request:",A),console.log("Final request array being sent:",[A]),console.log("Checking types before mutation:"),console.log("- executeIntentReq type:",typeof A),console.log("- executeIntentReq.execute_intent.intent_ids type:",typeof A.execute_intent.intent_ids[0]),console.log("- satisfyingIntentFeatures length:",v.length);let C=await i.mutateAsync([A]);alert("Purchase successful!"),console.log("Purchase result:",C)}catch(O){console.error("Purchase failed:",O),alert("Purchase failed. Please try again.")}},m=te(a),{data:p,isLoading:f,error:N}=m,o=u.status==="pending"||i.status==="pending";if(f)return t.jsx("span",{className:"text-gray-400",children:"Loading price..."});if(N)return t.jsx("span",{className:"text-red-500",children:"Error loading token info"});if(!p)return t.jsx("span",{className:"text-gray-400",children:"No token info"});const{symbol:h,decimals:_,fee:x}=p,k=_!=null?Number(e)/10**_:e.toString();return t.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[t.jsxs("span",{className:"font-mono text-green-700",children:[h," ",k]}),t.jsx("button",{className:"ml-2 px-3 py-1 rounded bg-blue-600 text-white text-xs hover:bg-blue-700",onClick:g,disabled:o,children:o?"Processing...":"Buy"})]})}function De({nftCanisterId:e,tokenId:a,marketCanisterId:s,user:r}){const[d,l]=y.useState(!1),[c,n]=y.useState($[0]),[u,i]=y.useState(""),[g,m]=y.useState(!1),p=Ke(e),f=se(s),N=async()=>{if(!u||isNaN(Number(u))){alert("Please enter a valid price");return}m(!0);try{const o=typeof a=="string"?BigInt(a):a,h=BigInt(Math.floor(Number(u)*Math.pow(10,c.decimals)));console.log("Listing NFT:",{nftCanisterId:e,tokenId:o,price:h,selectedToken:c});const _={token_id:o,approval_info:{from_subaccount:[],spender:{owner:T.fromText(s),subaccount:[]},memo:[],expires_at:[],created_at_time:[BigInt(Date.now()*1e6)]}};console.log("Approving NFT for market:",_);const x=await p.mutateAsync(_);if(console.log("Approve result:",x),Array.isArray(x)&&x.length>0){const F=x[0];if(Array.isArray(F)&&F.length>0){const R=F[0];if(R&&typeof R=="object"&&"Err"in R){console.error("Approval error:",R.Err),alert("Failed to approve NFT for listing");return}}}const k={owner:typeof r.principal=="string"?T.fromText(r.principal):r.principal,subaccount:[]},w={canister:T.fromText(e),inventory:[{tokenIds:[o]}],meta:[],token_pointer:[]},O={canister:T.fromText(c.canisterId),inventory:[{quantity:h}],meta:[],token_pointer:[]},b={list_intent:[[{intent_tokens:[{target_intent_id:[],owner:k,kind:{intent:[[w]]},counterparty:[],lock_to_date:[]}]}],[{satisfying_tokens:[[O]]}]]};console.log("Creating listing intent:",b);const E=await f.mutateAsync([b]);console.log("List result:",E),alert("NFT listed successfully!"),l(!1),i(""),window.location.reload()}catch(o){console.error("Failed to list NFT:",o),alert("Failed to list NFT. Please try again.")}finally{m(!1)}};return d?t.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 mt-2",children:[t.jsx("h4",{className:"text-sm font-semibold mb-2",children:"List NFT for Sale"}),t.jsxs("div",{className:"mb-2",children:[t.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Accept Token:"}),t.jsx("select",{value:c.canisterId,onChange:o=>{const h=$.find(_=>_.canisterId===o.target.value);h&&n(h)},className:"w-full text-xs border rounded px-2 py-1",children:$.map(o=>t.jsxs("option",{value:o.canisterId,children:[o.symbol," - ",o.name]},o.canisterId))})]}),t.jsxs("div",{className:"mb-2",children:[t.jsxs("label",{className:"block text-xs text-gray-600 mb-1",children:["Price (",c.symbol,"):"]}),t.jsx("input",{type:"number",step:"0.01",min:"0",value:u,onChange:o=>i(o.target.value),placeholder:"Enter price",className:"w-full text-xs border rounded px-2 py-1"})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:N,disabled:g||!u,className:"flex-1 px-3 py-1 rounded bg-blue-600 text-white text-xs hover:bg-blue-700 disabled:bg-gray-400",children:g?"Listing...":"List NFT"}),t.jsx("button",{onClick:()=>l(!1),className:"px-3 py-1 rounded bg-gray-400 text-white text-xs hover:bg-gray-500",children:"Cancel"})]})]}):t.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[t.jsx("span",{className:"text-gray-500 text-xs",children:"You own this NFT"}),t.jsx("button",{className:"ml-2 px-3 py-1 rounded bg-green-600 text-white text-xs hover:bg-green-700",onClick:()=>l(!0),children:"List for Sale"})]})}function et({canisterId:e,tokenId:a,nftMetadata:s,marketId:r}){try{let d=function(){return g?t.jsx("div",{className:"text-xs text-red-500",children:"Error loading owner"}):u?t.jsxs("div",{className:"text-xs text-gray-500 truncate",children:["Owner: ",t.jsx("span",{title:u.owner,children:u.owner})]}):t.jsx("div",{className:"text-xs text-gray-400",children:"Owner: Unknown"})},l=function(){var p;return r?m.error?t.jsx("div",{className:"text-xs text-red-500",children:"Error loading listing"}):t.jsx("div",{className:"text-xs text-green-600 mt-2",children:t.jsx(ce,{listing:m.listing,marketCanisterId:r,intentId:(p=m.listing)==null?void 0:p.intent_id,nftCanisterId:e,tokenId:a,owner:u})}):null};const n=s&&typeof s=="object"&&("loading"in s||"metadata"in s||"error"in s)?s:ne(e,a),{owner:u,loading:i,error:g}=ae(e,a),m=r?re(r,e,a):{listing:null,loading:!1,error:null};return n.loading||i||m.loading?t.jsxs("div",{className:"animate-pulse bg-gray-100 rounded-xl p-4",children:[t.jsx("div",{className:"bg-gray-300 h-48 rounded-lg mb-4"}),t.jsx("div",{className:"h-4 bg-gray-300 rounded w-3/4 mb-2"}),t.jsx("div",{className:"h-4 bg-gray-300 rounded w-1/2"})]}):n.error||!n.metadata?(console.error("Error loading NFT metadata:",n.error),t.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 rounded-xl p-4",children:"Error loading NFT metadata."})):t.jsx(t.Fragment,{children:n.metadata&&n.metadata.parsedMetadata&&n.metadata.parsedMetadata.icrc97&&typeof n.metadata.parsedMetadata.icrc97=="object"&&Object.keys(n.metadata.parsedMetadata.icrc97).some(p=>p!=="attributes"&&n.metadata&&n.metadata.parsedMetadata.icrc97[p])?t.jsxs("div",{className:"bg-white shadow-md rounded-2xl p-4",children:[t.jsx("img",{src:n.metadata.parsedMetadata.icrc97.image,alt:n.metadata.parsedMetadata.icrc97.name,className:"w-full h-48 object-cover rounded-lg"}),t.jsx("h3",{className:"mt-4 text-xl font-semibold text-gray-900",children:n.metadata.parsedMetadata.icrc97.name}),t.jsxs("div",{className:"mt-1 text-gray-500 text-xs",children:["Token ID: ",a.toString()]}),d(),l(),n.metadata.parsedMetadata.icrc97.description&&t.jsx("p",{className:"mt-2 text-gray-600 text-sm",children:n.metadata.parsedMetadata.icrc97.description})]}):n.metadata&&n.metadata.parsedMetadata?(()=>{let p=null;try{p=n.metadata.parsedMetadata.icrc97raw?JSON.parse(n.metadata.parsedMetadata.icrc97raw):null}catch{}return p&&typeof p=="object"?t.jsxs("div",{children:[t.jsxs("div",{className:"mb-2 text-gray-500 text-xs",children:["Token ID: ",a.toString()]}),d(),l(),t.jsx("pre",{className:"bg-gray-50 rounded-xl p-4 text-xs overflow-x-auto",children:JSON.stringify(p,null,2)})]}):n.metadata.parsedMetadata.icrc97raw&&n.metadata.parsedMetadata.icrc97raw.trim()!==""?t.jsxs("div",{children:[t.jsxs("div",{className:"mb-2 text-gray-500 text-xs",children:["Token ID: ",a.toString()]}),d(),l(),t.jsx("pre",{className:"bg-gray-50 rounded-xl p-4 text-xs overflow-x-auto",children:n.metadata.parsedMetadata.icrc97raw})]}):t.jsx("div",{className:"bg-yellow-50 border border-yellow-200 text-yellow-700 rounded-xl p-4",children:"No displayable metadata found."})})():t.jsx("div",{className:"bg-yellow-50 border border-yellow-200 text-yellow-700 rounded-xl p-4",children:"No metadata available."})})}catch(d){return console.error("Error rendering NFTCard:",d),t.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 rounded-xl p-4",children:"Error rendering NFT card."})}}const I=[10,100,1e3],tt="uxrrr-q7777-77774-qaaaq-cai",nt=({canisterId:e,tokenIds:a,loading:s,error:r})=>{const[d,l]=y.useState("tile"),[c,n]=y.useState(1),[u,i]=y.useState(I[0]),[g,m]=y.useState(""),p=g?a.filter(o=>o.toString().includes(g)):a,f=Math.ceil(p.length/u),N=p.slice((c-1)*u,c*u);return console.log("loading,error",s,r),s?t.jsx("div",{className:"py-8 text-center text-blue-400",children:"Loading NFTs..."}):r?t.jsx("div",{className:"py-8 text-center text-red-600",children:"Error loading NFTs"}):t.jsxs("div",{className:"max-w-5xl mx-auto p-6",children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-4 mb-4",children:[t.jsx("input",{className:"border rounded px-3 py-1",placeholder:"Search by token_id...",value:g,onChange:o=>{m(o.target.value),n(1)}}),t.jsx("select",{className:"border rounded px-2 py-1",value:u,onChange:o=>{i(Number(o.target.value)),n(1)},children:I.map(o=>t.jsxs("option",{value:o,children:[o," per page"]},o))}),t.jsxs("div",{className:"ml-auto flex gap-2",children:[t.jsx("button",{className:`px-3 py-1 rounded ${d==="tile"?"bg-blue-500 text-white":"bg-gray-200"}`,onClick:()=>l("tile"),children:"Tile"}),t.jsx("button",{className:`px-3 py-1 rounded ${d==="list"?"bg-blue-500 text-white":"bg-gray-200"}`,onClick:()=>l("list"),children:"List"})]})]}),d==="tile"?t.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:N.map(o=>t.jsx(et,{canisterId:e,tokenId:o,marketId:tt},o.toString()))}):t.jsxs("table",{className:"w-full border rounded-lg bg-white shadow-sm text-sm",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"bg-gray-100",children:[t.jsx("th",{className:"p-2 text-left",children:"#"}),t.jsx("th",{className:"p-2 text-left",children:"Image"}),t.jsx("th",{className:"p-2 text-left",children:"Name"}),t.jsx("th",{className:"p-2 text-left",children:"Owner"}),t.jsx("th",{className:"p-2 text-left",children:"Market Listing"}),t.jsx("th",{className:"p-2 text-left",children:"Description"})]})}),t.jsx("tbody",{children:N.map((o,h)=>t.jsx(at,{canisterId:e,tokenId:o,index:(c-1)*u+h+1},o.toString()))})]}),t.jsxs("div",{className:"flex justify-between items-center mt-6",children:[t.jsxs("span",{children:["Page ",c," of ",f," (",p.length," items)"]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{className:"px-2 py-1 border rounded disabled:opacity-50",onClick:()=>n(o=>Math.max(1,o-1)),disabled:c===1,children:"Prev"}),t.jsx("button",{className:"px-2 py-1 border rounded disabled:opacity-50",onClick:()=>n(o=>Math.min(f,o+1)),disabled:c===f,children:"Next"})]})]})]})},at=({canisterId:e,tokenId:a,index:s})=>{var o,h,_,x,k,w;const{metadata:r,loading:d}=ne(e,a),{owner:l,loading:c,error:n}=ae(e,a),u="uxrrr-q7777-77774-qaaaq-cai",{listing:i,loading:g,error:m}=re(u,e,a),p=(h=(o=r==null?void 0:r.parsedMetadata)==null?void 0:o.icrc97)==null?void 0:h.image,f=(x=(_=r==null?void 0:r.parsedMetadata)==null?void 0:_.icrc97)==null?void 0:x.name,N=(w=(k=r==null?void 0:r.parsedMetadata)==null?void 0:k.icrc97)==null?void 0:w.description;return t.jsxs("tr",{className:"border-t hover:bg-blue-50",children:[t.jsx("td",{className:"p-2 font-medium text-gray-900",children:s}),t.jsx("td",{className:"p-2",children:d?t.jsx("div",{className:"w-8 h-8 bg-gray-200 rounded animate-pulse"}):p?t.jsx("img",{src:p,alt:f||"NFT",className:"w-8 h-8 object-cover rounded"}):t.jsx("div",{className:"w-8 h-8 bg-gray-100 rounded flex items-center justify-center text-gray-400 text-xs",children:"?"})}),t.jsxs("td",{className:"p-2 text-gray-900",children:[f||t.jsx("span",{className:"text-gray-400",children:"..."}),t.jsxs("div",{className:"text-xs text-gray-500",children:["ID: ",a.toString()]})]}),t.jsx("td",{className:"p-2",children:c?t.jsx("span",{className:"text-xs text-gray-400",children:"Loading..."}):n?t.jsx("span",{className:"text-xs text-red-500",children:"Error"}):l?t.jsxs("span",{className:"text-xs text-gray-700 truncate",title:l.owner,children:["Owner: ",l.owner]}):t.jsx("span",{className:"text-xs text-gray-400",children:"Unknown"})}),t.jsx("td",{className:"p-2",children:g?t.jsx("span",{className:"text-xs text-gray-400",children:"Loading..."}):m?t.jsx("span",{className:"text-xs text-red-500",children:"Error"}):t.jsx("span",{className:"text-xs text-green-600",children:t.jsx(ce,{listing:i,marketCanisterId:u,intentId:i==null?void 0:i.intent_id,nftCanisterId:e,tokenId:a,owner:l})})}),t.jsx("td",{className:"p-2 text-gray-700",children:N?t.jsx("span",{className:"text-xs",children:N}):t.jsx("span",{className:"text-xs text-gray-400",children:"-"})})]})};function dt(){const{canisterId:e}=Ue({strict:!1});if(!e)return t.jsx("div",{className:"text-red-500",children:"Invalid collection ID"});const{tokenIds:a,loading:s,error:r}=ee(e);return t.jsxs("div",{className:"flex flex-col bg-[#522785] p-10 rounded-xl items-center text-xl text-white gap-5",children:[t.jsx(Ye,{canisterId:e}),t.jsx("div",{className:"w-full",children:t.jsx(nt,{canisterId:e,tokenIds:a,loading:s,error:r})})]})}export{dt as component};
